# 中望CAD查寻功能移植开发计划

## 一、项目概述
将AutoCAD动态块的查寻参数、查寻动作、查寻表、查寻集等功能完整移植到中望CAD2026，开发一个查寻功能插件，实现功能对等性和兼容性。

## 二、需求分析

### 1. 核心功能需求
- **BPARAMETER命令**：添加"查寻(K)"参数类型
- **BACTIONTOOL命令**：添加"查寻(L)"动作类型
- **查寻集功能**：创建中望CAD查寻集命令BPARAMSETLOOKUP
- **特性查寻表对话框**：自定义UI实现
- **添加参数特性对话框**：自定义UI实现
- **查寻夹点交互**：支持下拉菜单和标签显示
- **参数关联**：实现查寻参数与动作的关联机制

### 2. 开发环境
- **系统**：Windows 10 64位
- **开发工具**：Microsoft Visual Studio 2026
- **CAD平台**：ZWCAD 2026
- **SDK**：ZWSDK 2026（不支持32位）
- **UI框架**：MFC（共享DLL中使用）
- **字符集**：Unicode
- **目标文件扩展名**：.zrx
- **运行库**：多线程DLL (/MD)
- **C++标准**：ISO C++20 (/std:c++20)
- **C标准**：ISO C17 (/std:c17)
- **Windows SDK**：版本10（最新版本）

## 三、详细开发计划

### 1. 项目结构设计

```
ZWLookupPlugin/
├── ZWLookupDefs.h           // 常量和类型定义
├── ZWLookupParameter.h/cpp  // 查寻参数实现
├── ZWLookupTable.h/cpp       // 查寻表实现
├── ZWLookupAction.h/cpp      // 查寻动作实现
├── ZWLookupSet.h/cpp         // 查寻集实现
├── ZWLookupDialog.h/cpp      // 对话框实现
├── ZWLookupGripManager.h/cpp // 夹点管理器
├── ZWLookupCommands.h/cpp    // 命令实现
├── ZWLookupPlugin.h/cpp      // 插件入口
├── stdafx.h/cpp              // 预编译头文件
├── resource.h                // 资源定义
└── ZWLookupPlugin.rc         // 资源文件
```

### 2. 开发阶段划分

#### 2.1 系统分析与设计阶段（2周）

| 任务编号 | 任务描述 | 产出物 |
|----------|----------|--------|
| SA-001   | 分析AutoCAD查寻参数的数据结构 | 数据结构分析报告 |
| SA-002   | 分析AutoCAD查寻动作的执行机制 | 执行流程文档 |
| SA-003   | 研究查寻表在DWG中的存储格式 | 存储格式规范 |
| SA-004   | 分析查寻参数与动作的关联机制 | 关联机制文档 |
| SA-005   | 研究查寻功能的UI交互流程 | UI交互流程图 |
| SB-001   | 分析中望CAD块系统架构 | 架构对比报告 |
| SB-002   | 评估中望CAD参数系统扩展性 | 扩展性评估报告 |
| SB-003   | 研究中望CAD动作系统接口 | 接口文档 |
| SB-004   | 分析中望CAD夹点系统兼容性 | 夹点系统分析 |
| SC-001   | 设计查寻参数类结构 | 类设计文档 |
| SC-002   | 设计查寻动作类结构 | 类设计文档 |
| SC-003   | 设计查寻表存储结构 | 存储设计文档 |
| SC-004   | 设计参数-动作关联机制 | 关联设计文档 |
| SC-005   | 设计文件兼容性方案 | 兼容性方案 |

#### 2.2 核心功能开发阶段（8周）

| 任务编号 | 任务描述 | 依赖项 |
|----------|----------|--------|
| SD-001   | 创建查寻参数基类 | SC-001 |
| SD-002   | 实现查寻参数数据成员 | SD-001 |
| SD-003   | 创建查寻动作基类 | SC-002 |
| SD-004   | 实现查寻动作数据成员 | SD-003 |
| SD-005   | 实现参数工厂注册机制 | SD-001 |
| SD-006   | 实现动作工厂注册机制 | SD-003 |
| SE-001   | 实现查寻表数据结构 | SC-003 |
| SE-002   | 实现查寻表加载/保存 | SE-001 |
| SE-003   | 实现查寻表条目管理 | SE-001 |
| SE-004   | 实现查寻参数值系统 | SD-001 |
| SE-005   | 实现正向查寻功能 | SE-004 |
| SE-006   | 实现反向查寻功能 | SE-004 |
| SE-007   | 实现查寻参数夹点系统 | SB-004 |
| SE-008   | 实现查寻参数显示控制 | SE-007 |
| SF-001   | 实现查寻动作执行引擎 | SD-003 |
| SF-002   | 实现查寻表关联机制 | SE-001, SF-001 |
| SF-003   | 实现动作执行上下文 | SF-001 |
| SF-004   | 实现查寻结果应用 | SF-002 |
| SF-005   | 实现动作预览系统 | SF-001 |
| SF-006   | 实现动作回滚机制 | SF-004 |
| SF-007   | 实现查寻动作验证 | SF-002 |
| SG-001   | 实现参数-动作关联管理器 | SC-004 |
| SG-002   | 实现查寻参数与动作的关联 | SE-004, SF-002 |
| SG-003   | 实现关联属性管理 | SG-001 |
| SG-004   | 实现关联变更传播 | SG-002 |
| SG-005   | 实现关联依赖分析 | SG-001 |
| SG-006   | 实现关联验证系统 | SG-001 |
| SU-001   | 设计查寻集类结构 | SC-001 |
| SU-002   | 实现查寻集基类 | SU-001 |
| SU-003   | 实现查寻集数据成员 | SU-002 |
| SU-004   | 实现查寻集条目管理 | SU-003 |
| SU-005   | 实现查寻集与参数关联机制 | SU-002, SG-001 |
| SU-006   | 实现查寻集选择器 | SU-004 |
| SU-007   | 实现查寻集状态管理 | SU-005 |
| SU-008   | 实现查寻集验证系统 | SU-003 |

#### 2.3 用户交互界面阶段（4周）

| 任务编号 | 任务描述 | 依赖项 |
|----------|----------|--------|
| SK-001   | 实现BPARAMETER命令框架 | SE-004 |
| SK-002   | 实现查寻参数创建命令 | SK-001 |
| SK-003   | 实现查寻参数编辑命令 | SK-002 |
| SK-004   | 实现BACTIONTOOL命令框架 | SF-001 |
| SK-005   | 实现查寻动作创建命令 | SK-004 |
| SK-006   | 实现查寻动作编辑命令 | SK-005 |
| SK-007   | 实现命令参数验证 | SK-002, SK-005 |
| SK-008   | 实现命令撤销/重做 | SK-003, SK-006 |
| TL-001   | 设计查寻表编辑器UI | SA-005 |
| TL-002   | 实现特性查寻表对话框 | TL-001, SE-003 |
| TL-003   | 实现添加参数特性对话框 | TL-002 |
| TL-004   | 实现查寻条目管理界面 | TL-002 |
| TL-005   | 实现查寻表预览功能 | TL-002 |
| TL-006   | 实现查寻表导入/导出 | TL-002 |
| TL-007   | 实现自定义查寻参数属性面板 | SE-004 |
| TL-008   | 实现自定义查寻动作属性面板 | SF-001 |
| TL-009   | 实现自定义UI与数据同步机制 | TL-007, TL-008 |
| TW-001   | 设计查寻集编辑器UI | TL-001 |
| TW-002   | 实现查寻集管理对话框 | SU-006, TW-001 |
| TW-003   | 实现查寻集选择器界面 | SU-006, TW-002 |
| TW-004   | 实现查寻集与参数关联界面 | TW-002, SG-003 |
| TW-005   | 实现查寻集预览功能 | TW-002 |
| TW-006   | 集成查寻集到参数创建流程 | SK-002, TW-002 |
| TM-001   | 实现查寻参数夹点显示 | SE-007 |
| TM-002   | 实现夹点下拉菜单功能 | TM-001 |
| TM-003   | 实现夹点提示文本 | TM-001 |
| TM-004   | 实现夹点上下文菜单 | TM-002 |
| TM-005   | 实现夹点编辑预览 | TM-002 |
| TM-006   | 实现夹点捕捉控制 | TM-002 |
| TM-007   | 实现夹点状态管理 | TM-001 |

#### 2.4 文件格式兼容性阶段（2周）

| 任务编号 | 任务描述 | 依赖项 |
|----------|----------|--------|
| TH-001   | 实现DWG查寻参数读取 | SE-001 |
| TH-002   | 实现DWG查寻动作读取 | SF-001 |
| TH-003   | 实现DWG查寻表读取 | SE-001 |
| TH-004   | 实现关联关系读取 | SG-001 |
| TH-005   | 实现DWG查寻集读取 | SU-003 |
| TH-006   | 实现DWG版本兼容性处理 | TH-001, TH-002 |
| TH-007   | 实现读取错误恢复机制 | TH-001, TH-002 |
| TI-001   | 实现DWG查寻参数写入 | SE-001 |
| TI-002   | 实现DWG查寻动作写入 | SF-001 |
| TI-003   | 实现DWG查寻表写入 | SE-001 |
| TI-004   | 实现关联关系写入 | SG-001 |
| TI-005   | 实现DWG查寻集写入 | SU-003 |
| TI-006   | 实现版本兼容性写入 | TI-001, TI-002 |
| TI-007   | 实现数据压缩优化 | TI-001 |
| TJ-001   | 创建AutoCAD测试文件集 | 无 |
| TJ-002   | 实现格式兼容性测试工具 | TH-001, TI-001 |
| TJ-003   | 执行双向兼容性测试 | TJ-001, TJ-002 |
| TJ-004   | 修复发现的兼容性问题 | TJ-003 |

#### 2.5 测试与验证阶段（4周）

| 任务编号 | 任务描述 | 依赖项 |
|----------|----------|--------|
| TN-001   | 编写查寻参数单元测试 | SE-008 |
| TN-002   | 编写查寻动作单元测试 | SF-007 |
| TN-003   | 编写查寻表单元测试 | SE-003 |
| TN-004   | 编写查寻集单元测试 | SU-008 |
| TN-005   | 编写关联系统单元测试 | SG-006 |
| TN-006   | 编写文件读写单元测试 | TH-007, TI-007 |
| TN-007   | 执行单元测试并修复问题 | TN-001~TN-006 |
| TO-001   | 创建集成测试场景 | 无 |
| TO-002   | 测试参数-动作完整流程 | SG-004, TO-001 |
| TO-003   | 测试多参数关联场景 | TO-002 |
| TO-004   | 测试嵌套块查寻功能 | TO-003 |
| TO-005   | 测试大文件性能 | TO-001 |
| TO-006   | 修复集成测试问题 | TO-002~TO-005 |
| TP-001   | 测试AutoCAD文件导入 | TH-007, TJ-003 |
| TP-002   | 测试中望CAD文件导出到AutoCAD | TI-007, TJ-003 |
| TP-003   | 测试版本向下兼容性 | TP-001, TP-002 |
| TP-004   | 测试第三方软件兼容性 | TP-001 |
| TP-005   | 修复兼容性问题 | TP-001~TP-004 |
| TX-001   | 编写查寻集单元测试 | SU-008 |
| TX-002   | 测试查寻集与参数关联功能 | SU-005, SG-006 |
| TX-003   | 测试查寻集文件兼容性 | TH-005, TI-005 |
| TX-004   | 测试多查寻集场景 | TX-002 |
| TX-005   | 修复查寻集相关问题 | TX-001~TX-004 |
| TQ-001   | 测试命令响应性 | SK-008 |
| TQ-002   | 测试对话框交互流程 | TL-009 |
| TQ-003   | 测试夹点交互体验 | TM-007 |
| TQ-004   | 测试撤销/重做功能 | TQ-001 |
| TQ-005   | 收集用户反馈 | TQ-002, TQ-003 |
| TQ-006   | 优化用户体验 | TQ-005 |

#### 2.6 性能优化与文档阶段（3周）

| 任务编号 | 任务描述 | 依赖项 |
|----------|----------|--------|
| TR-001   | 分析查寻功能性能瓶颈 | TO-005 |
| TR-002   | 优化查寻表查找算法 | SE-003, TR-001 |
| TR-003   | 实现查寻结果缓存 | SE-005, TR-001 |
| TR-004   | 优化文件读写性能 | TH-007, TI-007 |
| TR-005   | 优化UI响应速度 | TL-009, TR-001 |
| TR-006   | 性能回归测试 | TR-002~TR-005 |
| TS-001   | 编写API接口文档 | SC-001~SC-005 |
| TS-002   | 编写用户操作手册 | SK-008, TL-009 |
| TS-003   | 编写开发指南 | TS-001 |
| TS-004   | 编写故障排除指南 | TN-007, TO-006 |
| TS-005   | 编写升级迁移指南 | TP-003 |
| TS-006   | 制作培训视频教程 | TS-002 |
| TT-001   | 代码合并与冲突解决 | 所有开发任务 |
| TT-002   | 构建最终发布版本 | TT-001 |
| TT-003   | 执行最终验证测试 | TT-002 |
| TT-004   | 准备发布说明 | TS-002 |
| TT-005   | 部署到测试环境 | TT-002 |
| TT-006   | 正式发布 | TT-004, TT-005 |

## 四、风险分析与应对

### 1. 技术风险

| 风险描述 | 可能性 | 影响程度 | 应对措施 |
|----------|--------|----------|----------|
| 中望CAD API限制 | 中 | 高 | 提前验证API能力，准备替代方案 |
| 文件格式逆向困难 | 中 | 高 | 投入更多分析时间，寻求AutoCAD文档 |
| 性能不达标 | 低 | 中 | 设计时考虑性能，留出优化时间 |
| 兼容性问题 | 高 | 高 | 制定详细兼容性测试计划 |

### 2. 质量风险

| 风险描述 | 可能性 | 影响程度 | 应对措施 |
|----------|--------|----------|----------|
| 功能不完整 | 低 | 高 | 制定详细验收标准 |
| 用户体验差 | 中 | 中 | 早期用户测试，迭代改进 |
| 稳定性问题 | 中 | 高 | 加强测试，特别是边界条件测试 |

## 五、成功标准与验收指标

### 1. 功能完整性

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 查寻参数支持率 | 100% | 功能测试用例通过率 |
| 查寻动作支持率 | 100% | 功能测试用例通过率 |
| 查寻表功能完整性 | 100% | 功能测试用例通过率 |
| 查寻集功能完整性 | 100% | 功能测试用例通过率 |
| 命令兼容性 | 100% | 命令测试用例通过率 |

### 2. 性能指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 查寻响应时间 | <100ms | 性能测试工具 |
| 文件加载时间 | 与AutoCAD相当 | 对比测试 |
| 内存占用 | 与AutoCAD相当 | 内存监控工具 |

### 3. 兼容性指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| AutoCAD文件导入成功率 | 99% | 兼容性测试 |
| 中望CAD文件导出成功率 | 99% | 兼容性测试 |
| 第三方软件识别率 | 95% | 兼容性测试 |

### 4. 用户体验指标

| 指标 | 目标值 | 测量方法 |
|------|--------|----------|
| 操作学习时间 | <30分钟 | 用户测试 |
| 用户满意度 | >4.5/5分 | 用户调查问卷 |
| 错误率 | <5% | 用户测试记录 |

## 六、项目管理建议

1. **采用敏捷开发**：分阶段交付，每2周一个迭代
2. **持续集成**：每天构建，自动化测试
3. **代码评审**：所有代码必须经过同行评审
4. **文档同步**：代码与文档同步更新
5. **测试驱动开发**：重要功能先写测试用例
6. **代码覆盖率**：核心代码覆盖率要求>90%
7. **性能基准测试**：建立性能基准，防止退化
8. **用户参与测试**：邀请真实用户参与测试

## 七、总结

通过本计划的实施，中望CAD将获得与AutoCAD对等的动态块查寻功能，显著提升其在参数化设计领域的竞争力。项目成功的关键在于：

1. **深入的技术分析**：充分理解AutoCAD实现机制
2. **合理的架构设计**：确保扩展性和维护性
3. **严格的测试验证**：保证功能完整性和兼容性
4. **良好的用户体验**：确保易用性和稳定性

该计划详细规划了从系统分析到最终发布的完整流程，覆盖了所有核心功能和技术要点，为项目的成功实施提供了坚实的基础。